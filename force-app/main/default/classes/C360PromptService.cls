public with sharing class C360PromptService {

    @AuraEnabled
    public static Map<String, String> generateC360Summary(String formattedName) {
        if (String.isBlank(formattedName)) {
            throw new AuraHandledException('ê³ ê° ì´ë¦„ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        List<String> nameParts = formattedName.split(' ');
        if (nameParts.size() != 2) {
            throw new AuraHandledException('ì´ë¦„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        String firstName = nameParts[0];
        String lastName = nameParts[1];

        // Contact ì¡°íšŒ
        Contact contact = [
            SELECT Id, FirstName, LastName, MobilePhone, AccountId, Phone, Email
            FROM Contact
            WHERE FirstName = :firstName AND LastName = :lastName
            LIMIT 1
        ];

        // Account ì¡°íšŒ
        Account acct = [
            SELECT Id, Name, BillingCity, BillingStreet, Account_Code__c
            FROM Account
            WHERE Id = :contact.AccountId
            LIMIT 1
        ];

        // Asset ì¡°íšŒ
        List<Asset> assetList = [
            SELECT Name, Status
            FROM Asset
            WHERE AccountId = :acct.Id
            LIMIT 5
        ];

        // Case ì¡°íšŒ
        List<Case> recentCases = [
            SELECT Subject, Status, CreatedDate
            FROM Case
            WHERE ContactId = :contact.Id
            ORDER BY CreatedDate DESC
            LIMIT 5
        ];

        // í…ìŠ¤íŠ¸ ì¡°ë¦½
        String customerSummary = String.join(new List<String>{
            '- ì´ë¦„: ' + contact.FirstName + ' ' + contact.LastName,
            '- ì—°ë½ì²˜: ' + (contact.Phone != null ? contact.Phone : 'ì œê³µë˜ì§€ ì•ŠìŒ'),
            '- ì´ë©”ì¼: '+ (contact.Email != null ? contact.Email : 'ì œê³µë˜ì§€ ì•ŠìŒ')
        }, '\n');

        String accountSummary = String.join(new List<String>{
            '- ë³‘ì›ëª…: ' + acct.Name,
            '- ë³‘ì› ê·œëª¨: ' + (acct.Account_Code__c != null ? acct.Account_Code__c : 'ì—†ìŒ'),
            '- ì£¼ì†Œ: ' +
                (acct.BillingCity != null ? acct.BillingCity + ' ' : '') +
                (acct.BillingStreet != null ? acct.BillingStreet : 'ì£¼ì†Œ ì—†ìŒ')
        }, '\n');

        List<String> caseLines = new List<String>();
        for (Case c : recentCases) {
            caseLines.add('- ' + c.Subject + ' (' + c.Status + ', ' + String.valueOf(c.CreatedDate.date()) + ')');
        }
        String caseSummary = String.join(caseLines, '\n');

        List<String> assetLines = new List<String>();
        for (Asset a : assetList) {
            assetLines.add('- ' + a.Name + ' (' + a.Status + ')');
        }
        String assetSummary = String.join(assetLines, '\n');

        // LLM Prompt í˜¸ì¶œ ì¤€ë¹„
        Map<String, ConnectApi.WrappedValue> inputParams = new Map<String, ConnectApi.WrappedValue>{
            'Input:customerSection' => wrap(customerSummary),
            'Input:accountSection'  => wrap(accountSummary),
            'Input:caseSection'     => wrap(caseSummary),
            'Input:assetSection'    => wrap(assetSummary)
        };

        ConnectApi.EinsteinPromptTemplateGenerationsInput input = new ConnectApi.EinsteinPromptTemplateGenerationsInput();
        input.inputParams = inputParams;
        input.isPreview = false;
        input.additionalConfig = new ConnectApi.EinsteinLlmAdditionalConfigInput();
        input.additionalConfig.applicationName = 'PromptBuilderPreview';

        try {
            ConnectApi.EinsteinPromptTemplateGenerationsRepresentation response =
                ConnectApi.EinsteinLLM.generateMessagesForPromptTemplate('Customer_Summary_Gen', input);

            if (response.generations.isEmpty()) {
                throw new AuraHandledException('âš ï¸ LLM ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
            }

            String json = response.generations[0].text;
            System.debug('ğŸ“¨ LLM ì‘ë‹µ JSON: ' + json);

            Map<String, Object> parsed = (Map<String, Object>) System.JSON.deserializeUntyped(json);

            return new Map<String, String>{
               
                'customerSection' => ((String) parsed.get('customerSection')).replace('\n', '<br/>'),
                'accountSection'  => ((String) parsed.get('accountSection')).replace('\n', '<br/>'),
                'caseSection'     => ((String) parsed.get('caseSection')).replace('\n', '<br/>'),
                'assetSection'    => ((String) parsed.get('assetSection')).replace('\n', '<br/>')
            };
        } catch (Exception e) {
            System.debug(' ìš”ì•½ ì‹¤íŒ¨: ' + e.getMessage());
            throw new AuraHandledException('ìš”ì•½ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    @AuraEnabled
    public static C360DataResult getContactRelatedRecords(String formattedName) {
        if (String.isBlank(formattedName)) {
            throw new AuraHandledException('ê³ ê° ì´ë¦„ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        List<String> nameParts = formattedName.split(' ');
        if (nameParts.size() != 2) {
            throw new AuraHandledException('ì´ë¦„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        String firstName = nameParts[0];
        String lastName = nameParts[1];

        Contact contact = [
            SELECT Id, AccountId
            FROM Contact
            WHERE FirstName = :firstName AND LastName = :lastName
            LIMIT 1
        ];

        List<Case> caseList = [
            SELECT Id, Subject, Description, Status, CreatedDate
            FROM Case
            WHERE ContactId = :contact.Id
            ORDER BY CreatedDate DESC
            LIMIT 5
        ];

        List<Asset> assetList = [
            SELECT Id, Name, SerialNumber, Status, InstallDate
            FROM Asset
            WHERE AccountId = :contact.AccountId
            LIMIT 5
        ];

        C360DataResult result = new C360DataResult();
        result.contactId = contact.Id;
        result.accountId = contact.AccountId;
        result.cases = caseList;
        result.assets = assetList;
        return result;
    }

    // ğŸ”¹ ë°˜í™˜ìš© í´ë˜ìŠ¤
    public class C360DataResult {
        @AuraEnabled public Id contactId;
        @AuraEnabled public Id accountId;
        @AuraEnabled public List<Case> cases;
        @AuraEnabled public List<Asset> assets;
    }

    // ğŸ”¹ Prompt input í¬ë§·ìš© wrap í•¨ìˆ˜
    private static ConnectApi.WrappedValue wrap(String value) {
        ConnectApi.WrappedValue w = new ConnectApi.WrappedValue();
        w.value = value;
        return w;
    }
}
