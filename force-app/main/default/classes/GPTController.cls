public with sharing class GPTController {
    private static final String OPENAI_API_KEY = '';
    private static String lastCaseNumber;
    private static Boolean isWaitingForName = false;

    @AuraEnabled(cacheable=false)
    public static String sendToGPT(String userInput) {
        if (String.isBlank(userInput)) {
            isWaitingForName = false;
            return 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” OlymBot ğŸ¤– ì…ë‹ˆë‹¤.\nì§„í–‰ ì¤‘ì¸ ì¼€ì´ìŠ¤ ë²ˆí˜¸ê°€ ìˆìœ¼ì‹ ê°€ìš”?\nì—†ìœ¼ì‹œë©´ ì´ë¦„ìœ¼ë¡œ ì°¾ì•„ë“œë¦´ê²Œìš”.';
        }

        if (userInput.contains('ëª¨ë¥´ê² ') || userInput.contains('ëª°ë¼') || userInput.contains('ë²ˆí˜¸ ì—†ì–´') || userInput.contains('ì—†')) {
            isWaitingForName = true;
            return 'ê´œì°®ìŠµë‹ˆë‹¤! OlymBot ğŸ¤–ì´(ê°€) ë„ì™€ë“œë¦´ê²Œìš”.\nì„±í•¨ì„ ì•Œë ¤ì£¼ì‹œë©´ ë“±ë¡ëœ ì¼€ì´ìŠ¤ë¥¼ ì°¾ì•„ë“œë¦¬ê² ìŠµë‹ˆë‹¤.';
        }

        // GPTì—ê²Œ ì´ë¦„ ì¶”ì¶œ ìš”ì²­
        String extractPrompt = 'ë‹¤ìŒ ë¬¸ì¥ì—ì„œ í•œêµ­ì‹ ì´ë¦„ì„ ì¶”ì¶œí•´ì„œ JSONìœ¼ë¡œ ë°˜í™˜í•´ì¤˜. ' +
            'ì´ë¦„ì´ ë¶™ì–´ ìˆìœ¼ë©´ ë„ì–´ì“°ê¸°ë¡œ ì„±ê³¼ ì´ë¦„ì„ ë¶„ë¦¬í•´ì¤˜. ì˜ˆ: "ê°•ì˜ˆì§€" â†’ {"name": "ì˜ˆì§€ ê°•"}, "ê°• ì˜ˆì§€" â†’ {"name": "ì˜ˆì§€ ê°•"} ' +
            'ì´ë¦„ì´ ì—†ìœ¼ë©´ ë¹ˆ JSON ë°˜í™˜. ì…ë ¥: ' + userInput;

        String gptResponse = askGPT(extractPrompt);
        Map<String, Object> parsed;
        try {
            parsed = (Map<String, Object>) JSON.deserializeUntyped(gptResponse);
        } catch (Exception e) {
            return 'ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì‹œê² ì–´ìš”?';
        }

        if (parsed.containsKey('name')) {
            String name = (String) parsed.get('name');
            isWaitingForName = false;
            List<Case> cases = [
                SELECT CaseNumber, Subject, Status, LastModifiedDate
                FROM Case
                WHERE Contact.Name LIKE :('%' + name + '%')
                ORDER BY LastModifiedDate DESC
                LIMIT 1
            ];

            if (cases.isEmpty()) {
                return 'ì£„ì†¡í•´ìš”. "' + name + '" ë‹˜ìœ¼ë¡œ ë“±ë¡ëœ ì¼€ì´ìŠ¤ê°€ ì—†ì–´ìš”. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì‹œê² ì–´ìš”?';
            }

            lastCaseNumber = cases[0].CaseNumber;
            return summarizeCase(cases[0]);
        }

        if (parsed.containsKey('caseNumber')) {
            lastCaseNumber = (String) parsed.get('caseNumber');
            return respondWithCaseSummary(lastCaseNumber);
        }

        if (isWaitingForName) {
            return 'ì„±í•¨ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì‹œê² ì–´ìš”?';
        }

        return 'ì§„í–‰ ì¤‘ì¸ ì¼€ì´ìŠ¤ ë²ˆí˜¸ë¥¼ ì•Œê³  ê³„ì‹ ê°€ìš”? ëª¨ë¥´ì‹ ë‹¤ë©´ ì„±í•¨ìœ¼ë¡œë„ ì°¾ì•„ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }

    private static String respondWithCaseSummary(String caseNumber) {
        List<Case> cases = [
            SELECT CaseNumber, Subject, Status, LastModifiedDate
            FROM Case
            WHERE CaseNumber = :caseNumber
            LIMIT 1
        ];

        if (cases.isEmpty()) {
            return 'í•´ë‹¹ ì¼€ì´ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        }

        return summarizeCase(cases[0]);
    }

    private static String summarizeCase(Case c) {
        String prompt = 'ë‹¤ìŒì€ ê³ ê° ì§€ì› ì¼€ì´ìŠ¤ì— ëŒ€í•œ ì •ë³´ì…ë‹ˆë‹¤. ì´ë¥¼ ì°¸ê³ í•˜ì—¬ ê³ ê°ì—ê²Œ ì •ì¤‘í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n' +
        '- ì¼€ì´ìŠ¤ ë²ˆí˜¸: ' + c.CaseNumber + '\n' +
        '- ì¼€ì´ìŠ¤ ì œëª©: "' + (String.isBlank(c.Subject) ? 'ì œëª© ì—†ìŒ' : c.Subject) + '"\n' +
        '- í˜„ì¬ ìƒíƒœ: "' + c.Status + '"\n' +
        '- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì¼ì‹œ: ' + String.valueOf(c.LastModifiedDate) + '\n\n' +
        'ì‘ë‹µì€ ê³ ê°ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ë¬¸ë‹¨ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.';
    

        return askGPT(prompt);
    }

    private static String askGPT(String prompt) {
        HttpRequest req = new HttpRequest();
        req.setEndpoint('https://api.openai.com/v1/chat/completions');
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json');
        req.setHeader('Authorization', OPENAI_API_KEY);

        Map<String, Object> payload = new Map<String, Object>{
            'model' => 'gpt-3.5-turbo',
            'messages' => new List<Map<String, String>>{
                new Map<String, String>{ 'role' => 'user', 'content' => prompt }
            }
        };

        req.setBody(JSON.serialize(payload));
        Http http = new Http();
        HttpResponse res = http.send(req);

        if (res.getStatusCode() != 200) {
            return 'GPT í˜¸ì¶œ ì‹¤íŒ¨: ' + res.getBody();
        }

        Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(res.getBody());
        Map<String, Object> choice = (Map<String, Object>)((List<Object>)result.get('choices'))[0];
        Map<String, Object> message = (Map<String, Object>)choice.get('message');
        return (String) message.get('content');
    }
}